<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FPU &mdash; VexiiRiscv  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/gh-fork-ribbon.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/vexiiriscv.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/logo3_32x32.png"/>
    <link rel="canonical" href="https://spinalhdl.github.io/VexiiRiscv-RTD/master/VexiiRiscv/Execute/fpu.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/skins/default.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/wavedrom.min.js"></script>
        <script src="../../_static/dialog.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Branch Prediction" href="../BranchPrediction/index.html" />
    <link rel="prev" title="Load Store Unit (LSU)" href="lsu.html" />
     
    <!-- source/_templates/layout.html -->
    
    
    

</head>

<body class="wy-body-for-nav">
     
    
    
    
    <div class="div-svg-github-corner github-corner-abs">
    <a href="https://github.com/SpinalHDL/VexiiRiscv-RTD/blob/master/source/VexiiRiscv/Execute/fpu.rst" class="github-corner github-fork-ribbon" aria-label="Edit on GitHub" data-ribbon="Edit on GitHub" title="Edit on GitHub">
      <object id="svg-github-corner" data="../../_static/github-corner-right.svg" class="svg-github-corner github-corner-abs" width="80" height="80"></object>
    </a>
    </div>
    
    
    

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VexiiRiscv
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction/index.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#other-doc-media-talks">Other doc / media / talks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#technicalities">Technicalities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#navigating-the-code">Navigating the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#about-vexriscv-not-vexiiriscv">About VexRiscv (not VexiiRiscv)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#check-list">Check list</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Framework/index.html">Framework</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#tools-and-api">Tools and API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#scala-spinalhdl">Scala / SpinalHDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#plugin-fiber-retainer">Plugin / Fiber / Retainer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Framework/index.html#simple-all-in-one-example">Simple all-in-one example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Framework/index.html#negotiation-example">Negotiation example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#database">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#pipeline-api">Pipeline API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Fetch/index.html">Fetch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#fetchpipelineplugin">FetchPipelinePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#pcplugin">PcPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#fetchcachelessplugin">FetchCachelessPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#fetchl1plugin">FetchL1Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#prefetchernextlineplugin">PrefetcherNextLinePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#btbplugin">BtbPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#gshareplugin">GSharePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#historyplugin">HistoryPlugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Decode/index.html">Decode</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Decode/index.html#decodepipelineplugin">DecodePipelinePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Decode/index.html#alignerplugin">AlignerPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Decode/index.html#decoderplugin">DecoderPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Decode/index.html#dispatchplugin">DispatchPlugin</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Execute</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">Plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#infrastructures">infrastructures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#executepipelineplugin">ExecutePipelinePlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#executelaneplugin">ExecuteLanePlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#regfileplugin">RegFilePlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#srcplugin">SrcPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#rsunsignedplugin">RsUnsignedPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#intformatplugin">IntFormatPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#writebackplugin">WriteBackPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#learnplugin">LearnPlugin</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#instructions">Instructions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#intaluplugin">IntAluPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#barrelshifterplugin">BarrelShifterPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#branchplugin">BranchPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#mulplugin">MulPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#divplugin">DivPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#lsucachelessplugin">LsuCachelessPlugin</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#special">Special</a><ul>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#csraccessplugin">CsrAccessPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#csrramplugin">CsrRamPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#privilegedplugin">PrivilegedPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#performancecounterplugin">PerformanceCounterPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#envplugin">EnvPlugin</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="custom.html">Custom instruction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="custom.html#simd-add">SIMD add</a><ul>
<li class="toctree-l4"><a class="reference internal" href="custom.html#plugin-implementation">Plugin implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom.html#vexiiriscv-generation">VexiiRiscv generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom.html#software-test">Software test</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom.html#simulation">Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom.html#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lsu.html">Load Store Unit (LSU)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="lsu.html#without-l1">Without L1</a></li>
<li class="toctree-l3"><a class="reference internal" href="lsu.html#with-l1">With L1</a></li>
<li class="toctree-l3"><a class="reference internal" href="lsu.html#memory-coherency">Memory coherency</a></li>
<li class="toctree-l3"><a class="reference internal" href="lsu.html#prefetching">Prefetching</a><ul>
<li class="toctree-l4"><a class="reference internal" href="lsu.html#prefetchrptplugin">PrefetchRptPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="lsu.html#performance-measurements">performance measurements</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">FPU</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#plugins-architecture">Plugins architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="#area-timings-options">Area / Timings options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimized-software">Optimized software</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../BranchPrediction/index.html">Branch Prediction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#btbplugin">BtbPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#gshareplugin">GSharePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#decodeplugin">DecodePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#branchplugin">BranchPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#learnplugin">LearnPlugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Debug/index.html">Debug</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Debug/jtag.html">JTAG</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../HowToUse/index.html">How to use</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#repo-setup">Repo setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#generate-verilog">Generate verilog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#run-a-simulation">Run a simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#synthesis">Synthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#other-resources">Other resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Performance/index.html">Performance / Area / FMax</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Performance/index.html#tuning">Tuning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Soc/index.html">SoC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Soc/microsoc.html">MicroSoc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Soc/microsoc.html#verilog-generation">Verilog generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Soc/microsoc.html#simulation-spinalsim-verilator">Simulation (SpinalSim / Verilator)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Soc/microsoc.html#adding-a-custom-peripheral">Adding a custom peripheral</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Soc/litex.html">Litex</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VexiiRiscv</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Execute</a></li>
      <li class="breadcrumb-item active">FPU</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/SpinalHDL/VexiiRiscv-RTD/blob/master/source/VexiiRiscv/Execute/fpu.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             <dialog id="doc-dialog-version" role="dialog" class="collapse-once" aria-modal="false" data-default-state="close" data-current-version="master" data-latest-version="master">
<p class="doc-version-warning-banner">
  <strong>
    
    You're reading an pre-release version of this documentation.<br/>
    For the latest stable release version, please have a look at <a href="fpu.html">master</a>.
    
  </strong>
  <div>
    <form>
      <button formmethod="dialog" type="submit" class="doc-dialog-dismiss" aria-label="close">Dismiss</button>
    </form>
  </div>
</p>
</dialog>




  <section id="fpu">
<h1>FPU<a class="headerlink" href="#fpu" title="Permalink to this heading"></a></h1>
<p>The VexiiRiscv FPU has the following characteristics :</p>
<ul class="simple">
<li><p>By default, It is fully compliant with the IEEE-754 spec (subnormal, rounding, exception flags, ..)</p></li>
<li><p>There is options to reduce its footprint at the cost of compliance (reduced FMA accuracy, and drop subnormal support)</p></li>
<li><p>It isn’t a single chunky module, instead it is composed of many plugins in the same ways than the rest of the CPU.</p></li>
<li><p>It is tightly coupled to the execute pipeline</p></li>
<li><p>All operations can be issued at the rate of 1 instruction per cycle, excepted for FDIV/FSQRT/Subnormals</p></li>
<li><p>By default, it is deeply pipelined to help with FPGA timings (10 stages FMA)</p></li>
<li><p>Multiple hardware resources are shared between multiple instruction (ex rounding, adder (FMA+FADD)</p></li>
<li><p>The VexiiRiscv scheduler take care to not schedule an instruction which would use the same resource than an older instruction</p></li>
<li><p>FDIV and FMUL reuse the integer pipeline DIV and MUL hardware</p></li>
<li><p>Subnormal numbers are handled by recoding/encoding them on operands and results of math instructions. This will trigger some little state machines which will halt the CPU a few cycles (2-3 cycles)</p></li>
</ul>
<section id="plugins-architecture">
<h2>Plugins architecture<a class="headerlink" href="#plugins-architecture" title="Permalink to this heading"></a></h2>
<p>There is a few foundation plugins that compose the FPU :</p>
<ul class="simple">
<li><p>FpuUnpackPlugin : Will decode the RS1/2/3 operands (isZero, isInfinity, ..) as well as recode them in a floating point format which simplify subnormals into regular floating point values</p></li>
<li><p>FpuPackPlugin : Will apply rounding to floating point results, recode them into IEEE-754 (including subnormal) before sending those to the WriteBackPlugin(float)</p></li>
<li><p>WriteBackPlugin(float) : Allows to write values back to the register file (it is the same implementation as the WriteBackPlugin(integer)</p></li>
<li><p>FpuFlagsWriteback ; Allows instruction to set FPU exception flags</p></li>
</ul>
<img alt="../../_images/fpu.png" src="../../_images/fpu.png" />
</section>
<section id="area-timings-options">
<h2>Area / Timings options<a class="headerlink" href="#area-timings-options" title="Permalink to this heading"></a></h2>
<p>To improve the FPU area and timings (especially on FPGA), there is currently two main options implemented.</p>
<p>The first option is to reduce the FMA (Float Multiply Add instruction A*B+C) accuracy.
The reason is that the mantissa result of the multiply operation (for 64 bits float) is 2x(52+1)=106 bits,
then we need to take those bits and implement the floating point adder against the third operand.
So, instead of having to do a 52 bits + 52 bits floating point adder,
we need to do a 106 bits + 52 bits floating point adder, which is quite heavy,
increase the timings and latencies while being (very likely) overkilled.
So this option throw away about half of the multiplication mantissa result.</p>
<p>The second option is to disable subnormal support, and instead consider those value as normal floating point numbers.
This reduce the area by not having to handle subnormals (it removes big barrels shifters)
, as well as improving timings.
The down side is that the floating point value range is slightly reduced,
and if the user provide floating point constants which are subnormals number,
they will be considered as 2^exp_subnormal numbers.</p>
<p>In practice those two option do not seems to creates issues (for regular use cases),
as it was tested by running debian with various software and graphical environnements.</p>
</section>
<section id="optimized-software">
<h2>Optimized software<a class="headerlink" href="#optimized-software" title="Permalink to this heading"></a></h2>
<p>If you used the default FPU configuration (deeply pipelined), and you want to achieve a high FPU bandwidth,
your software need to be careful about dependencies between instruction.
For instance, a FMA instruction will have around 10 cycle latency before providing its results,
so if you want for instance to multiply 1000 values against some constants
and accumulate the results together, you will need to accumulate things using multiple accumulators and then, only at the end, aggregate the accumulators together.</p>
<p>So think about code pipelining. GCC will not necessary do a got job about it,
as it may assume assume that the FPU has a much lower latency, or just optimize for code size.</p>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lsu.html" class="btn btn-neutral float-left" title="Load Store Unit (LSU)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../BranchPrediction/index.html" class="btn btn-neutral float-right" title="Branch Prediction" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 - 2024, VexiiRiscv.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
    <!-- source/_templates/footer.html -->
    
    <div class="doc-footer-current-version"><p>
    Version: master git~32e38e8 2024-11-04
    </p></div>
    


</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
       <dt>Languages</dt>
       <dd class="rtd-current-item">
         <a href="#">en</a>
       </dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="fpu.html">master</a></dd>
    </dl>
    <dl>
      <dt>Downloads</dt>
      <dd><a href="../../artefacts/VexiiRiscv_docs-master.">HTML</a></dd>
      <dd><a href="../../artefacts/VexiiRiscv_docs-master-SingleHTML.zip">SingleHTML</a></dd>
      <dd><a href="../../artefacts/VexiiRiscv_docs-master.pdf">PDF</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>