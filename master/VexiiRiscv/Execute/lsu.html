<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Load Store Unit (LSU) &mdash; VexiiRiscv  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/gh-fork-ribbon.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/vexiiriscv.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/logo3_32x32.png"/>
    <link rel="canonical" href="https://spinalhdl.github.io/VexiiRiscv-RTD/master/VexiiRiscv/Execute/lsu.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/skins/default.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/2.6.8/wavedrom.min.js"></script>
        <script src="../../_static/dialog.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="FPU" href="fpu.html" />
    <link rel="prev" title="Custom instruction" href="custom.html" />
     
    <!-- source/_templates/layout.html -->
    
    
    

</head>

<body class="wy-body-for-nav">
     
    
    
    
    <div class="div-svg-github-corner github-corner-abs">
    <a href="https://github.com/SpinalHDL/VexiiRiscv-RTD/blob/master/source/VexiiRiscv/Execute/lsu.rst" class="github-corner github-fork-ribbon" aria-label="Edit on GitHub" data-ribbon="Edit on GitHub" title="Edit on GitHub">
      <object id="svg-github-corner" data="../../_static/github-corner-right.svg" class="svg-github-corner github-corner-abs" width="80" height="80"></object>
    </a>
    </div>
    
    
    

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VexiiRiscv
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction/index.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#other-doc-media-talks">Other doc / media / talks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#technicalities">Technicalities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#navigating-the-code">Navigating the code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#about-risc-v">About RISC-V</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#about-vexriscv-not-vexiiriscv">About VexRiscv (not VexiiRiscv)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Introduction/index.html#check-list">Check list</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Framework/index.html">Framework</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#tools-and-api">Tools and API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#scala-spinalhdl">Scala / SpinalHDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#plugin-fiber-retainer">Plugin / Fiber / Retainer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Framework/index.html#simple-all-in-one-example">Simple all-in-one example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Framework/index.html#negotiation-example">Negotiation example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#database">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Framework/index.html#pipeline-api">Pipeline API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Fetch/index.html">Fetch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#fetchpipelineplugin">FetchPipelinePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#pcplugin">PcPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#fetchcachelessplugin">FetchCachelessPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#fetchl1plugin">FetchL1Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#prefetchernextlineplugin">PrefetcherNextLinePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#btbplugin">BtbPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#gshareplugin">GSharePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fetch/index.html#historyplugin">HistoryPlugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Decode/index.html">Decode</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Decode/index.html#decodepipelineplugin">DecodePipelinePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Decode/index.html#alignerplugin">AlignerPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Decode/index.html#decoderplugin">DecoderPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Decode/index.html#dispatchplugin">DispatchPlugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Decode/index.html#architecture">Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Decode/index.html#elaboration">Elaboration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Execute</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">Plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#infrastructures">Infrastructures</a><ul>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#executepipelineplugin">ExecutePipelinePlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#executelaneplugin">ExecuteLanePlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#regfileplugin">RegFilePlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#srcplugin">SrcPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#rsunsignedplugin">RsUnsignedPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#intformatplugin">IntFormatPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#writebackplugin">WriteBackPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#learnplugin">LearnPlugin</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#instructions">Instructions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#intaluplugin">IntAluPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#barrelshifterplugin">BarrelShifterPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#branchplugin">BranchPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#mulplugin">MulPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#divplugin">DivPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#lsucachelessplugin">LsuCachelessPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#lsuplugin">LsuPlugin</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html#special">Special</a><ul>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#csraccessplugin">CsrAccessPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#csrramplugin">CsrRamPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#privilegedplugin">PrivilegedPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#trapplugin">TrapPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#performancecounterplugin">PerformanceCounterPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="plugins.html#envplugin">EnvPlugin</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="custom.html">Custom instruction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="custom.html#simd-add">SIMD add</a><ul>
<li class="toctree-l4"><a class="reference internal" href="custom.html#plugin-implementation">Plugin implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom.html#vexiiriscv-generation">VexiiRiscv generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom.html#software-test">Software test</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom.html#simulation">Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="custom.html#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Load Store Unit (LSU)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#without-l1">Without L1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#with-l1">With L1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory-coherency">Memory coherency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prefetching">Prefetching</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#prefetchrptplugin">PrefetchRptPlugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performance-measurements">performance measurements</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="fpu.html">FPU</a><ul>
<li class="toctree-l3"><a class="reference internal" href="fpu.html#plugins-architecture">Plugins architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="fpu.html#area-timings-options">Area / Timings options</a></li>
<li class="toctree-l3"><a class="reference internal" href="fpu.html#optimized-software">Optimized software</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../BranchPrediction/index.html">Branch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#btbplugin">BtbPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#gshareplugin">GSharePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#decodeplugin">DecodePlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#branchplugin">BranchPlugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BranchPrediction/index.html#learnplugin">LearnPlugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Debug/index.html">Debug support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Debug/index.html#architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Debug/index.html#embeddedriscvjtag">EmbeddedRiscvJtag</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../HowToUse/index.html">How to use</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#repo-setup">Repo setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#generate-verilog">Generate verilog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#run-a-simulation">Run a simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#synthesis">Synthesis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HowToUse/index.html#other-resources">Other resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Performance/index.html">Performance / Area / FMax</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Performance/index.html#tuning">Tuning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Soc/index.html">SoC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Soc/microsoc.html">MicroSoc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Soc/microsoc.html#verilog-generation">Verilog generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Soc/microsoc.html#simulation-spinalsim-verilator">Simulation (SpinalSim / Verilator)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Soc/microsoc.html#adding-a-custom-peripheral">Adding a custom peripheral</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Soc/microsoc.html#exporting-an-apb3-bus-to-the-toplevel">Exporting an APB3 bus to the toplevel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Soc/litex.html">Litex</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VexiiRiscv</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Execute</a></li>
      <li class="breadcrumb-item active">Load Store Unit (LSU)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/SpinalHDL/VexiiRiscv-RTD/blob/master/source/VexiiRiscv/Execute/lsu.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             <dialog id="doc-dialog-version" role="dialog" class="collapse-once" aria-modal="false" data-default-state="close" data-current-version="master" data-latest-version="master">
<p class="doc-version-warning-banner">
  <strong>
    
    You're reading an pre-release version of this documentation.<br/>
    For the latest stable release version, please have a look at <a href="lsu.html">master</a>.
    
  </strong>
  <div>
    <form>
      <button formmethod="dialog" type="submit" class="doc-dialog-dismiss" aria-label="close">Dismiss</button>
    </form>
  </div>
</p>
</dialog>




  <section id="load-store-unit-lsu">
<span id="lsu"></span><h1>Load Store Unit (LSU)<a class="headerlink" href="#load-store-unit-lsu" title="Permalink to this heading"></a></h1>
<p>VexiiRiscv has 2 implementations of LSU :</p>
<ul class="simple">
<li><p>LsuCachelessPlugin for microcontrollers, which doesn’t implement any cache</p></li>
<li><p>LsuPlugin / LsuL1Plugin which can work together to implement load and store through an L1 cache</p></li>
</ul>
<section id="without-l1">
<h2>Without L1<a class="headerlink" href="#without-l1" title="Permalink to this heading"></a></h2>
<p>Implemented by the LsuCachelessPlugin, it should be noted that to
reach good frequencies on FPGA SoC, forking the memory request at
execute stage 1 seems to provide the best results (instead of execute stage 0),
as it relax the AGU timings as well as the PMA (Physical Memory Attributes) checks.</p>
<img alt="../../_images/lsu_nol1.png" src="../../_images/lsu_nol1.png" />
</section>
<section id="with-l1">
<h2>With L1<a class="headerlink" href="#with-l1" title="Permalink to this heading"></a></h2>
<p>This configuration supports :</p>
<ul class="simple">
<li><p>N ways (limited to 4 KB per way if the MMU is enabled)</p></li>
<li><p>Non-blocking design, able to handle multiple cache line refill and writeback</p></li>
<li><p>Hardware and software prefetching (RPT design)</p></li>
</ul>
<img alt="../../_images/lsu_l1.png" src="../../_images/lsu_l1.png" />
<p>This LSU implementation is partitioned between 2 plugins :</p>
<p>The LsuPlugin :</p>
<ul class="simple">
<li><p>Implement AGU (Address Generation Unit)</p></li>
<li><p>Arbitrate all the different sources of memory request (AGU, store queue, prefetch, MMU refill)</p></li>
<li><p>Provide the memory request to the LsuL1Plugin</p></li>
<li><p>Bind the MMU translation port</p></li>
<li><p>Handle the exceptions and hazard recovery</p></li>
<li><p>Handle the atomic operations (ALU + locking of the given cache line)</p></li>
<li><p>Handle IO memory accesses</p></li>
<li><p>Implement the store queue to handle store misses in a non-blocking way</p></li>
<li><p>Feed the hardware prefetcher with load/store execution traces</p></li>
</ul>
<p>The LsuL1Plugin :</p>
<ul class="simple">
<li><p>Implement the L1 tags and data storage</p></li>
<li><p>Implement the cache line refill and writeback slots (non-blocking)</p></li>
<li><p>Implement the store to load bypasses</p></li>
<li><p>Implement the memory coherency interface</p></li>
<li><p>Is integrated in the execute pipeline (to save area and improve timings)</p></li>
</ul>
<p>For multiple reasons (ease of implementation, FMax, hardware usage), VexiiRiscv LSU can hit hazards situations :</p>
<ul class="simple">
<li><p>Cache miss, MMU miss</p></li>
<li><p>Refill / Writeback aliasing (4KB)</p></li>
<li><p>Unread data bank during load (ex : load during data bank refill)</p></li>
<li><p>Load which hit the store queue</p></li>
<li><p>Store miss while the store queue is full</p></li>
<li><p>…</p></li>
</ul>
<p>In those situation, the LsuPlugin will trigger an “hardware trap”
which will flush the pipeline and reschedule the failed instruction to the fetch unit.</p>
</section>
<section id="memory-coherency">
<h2>Memory coherency<a class="headerlink" href="#memory-coherency" title="Permalink to this heading"></a></h2>
<p>Memory coherency (L1) with other memory agents (CPU, DMA, ..) is supported though a MESI implementation which can be bridged to a tilelink memory bus.</p>
<p>So, the L1 cache will have the following stream interfaces :</p>
<ul class="simple">
<li><p>read_cmd : To send memory block acquire requests (invalid/shared -&gt; shared/exclusive)</p></li>
<li><p>read_rsp : For responses of the above requests</p></li>
<li><p>read_ack : To send acquire requests completion</p></li>
<li><p>write_cmd : To send release a memory block permission (shared/exclusive -&gt; invalid)</p></li>
<li><p>write_rsp : For responses of the above requests</p></li>
<li><p>probe_cmd : To receive probe requests (toInvalid/toShared/toUnique)</p></li>
<li><p>probe_rsp : to send responses from the above requests (isInvalid/isShared/isUnique)</p></li>
</ul>
<p>PICTURE</p>
</section>
<section id="prefetching">
<h2>Prefetching<a class="headerlink" href="#prefetching" title="Permalink to this heading"></a></h2>
<p>Currently there is two implementation of prefetching</p>
<ul class="simple">
<li><p>PrefetchNextLinePlugin : As its name indicates, on each cache miss it will prefetch the next cache line</p></li>
<li><p>PrefetchRptPlugin : Enable prefetching for instruction which have a constant stride between accesses</p></li>
</ul>
<section id="prefetchrptplugin">
<h3>PrefetchRptPlugin<a class="headerlink" href="#prefetchrptplugin" title="Permalink to this heading"></a></h3>
<p>This prefetcher is capable of recognizing instructions which have a constant stride between their
own previous accesses in order to prefetch multiple strides ahead.</p>
<ul class="simple">
<li><p>Will learn memory accesses patterns from the LsuPlugin traces</p></li>
<li><p>Patterns need to have a constant stride in order to be recognized</p></li>
<li><p>By default, it can keep track of up to 128 instructions access pattern (1 way * 128 sets, pc indexed)</p></li>
</ul>
<img alt="../../_images/lsu_prefetch.png" src="../../_images/lsu_prefetch.png" />
<p>This can improve performance dramatically (for some use cases).
For instance, on a 100 MHz SoC in a FPGA, equipped of a 16x800 MT/s DDR3,
the load bandwidth went from 112 MB/s to 449  MB/s. (sequential load)</p>
<p>Here is a description of the table fields :</p>
<p>“Tag” : Allows to get a better idea if the given instruction (PC) is the one owning
the table entry by comparing more PC’s MSB bits.
An entry is “owned” by an instruction if its tag match the given instruction PC’s msb bits.</p>
<p>“Address” : Previous virtual address generated by the instruction</p>
<p>“stride” : Number of bytes expected between memory accesses</p>
<p>“Score” : Allows to know if the given entry is useful or not. Each time
the instruction is keeping the same stride, the score increase, else it decrease.
If another instruction (with another tag) want to use an entry,
the score field has to be low enough.</p>
<p>“Advance” : Allows to keep track how far the prefetching for the given
instruction already went. This field is cleared when a entry switch
to a new instruction</p>
<p>“Missed” : This field was added in order to reduce the spam of
redundant prefetch request which were happening for load/store intensive code.
For instance, for a deeply unrolled memory clear loop will generate (x16),
as each store instruction PC will be tracked individually,
and as each execution of a given instruction will stride over a full cache line,
this will generate one hardware prefetch request on each store instruction every
time, spamming the LSU pipeline with redundant requests
and reducing overall performances.</p>
<p>This “missed” field works as following :</p>
<ul class="simple">
<li><p>It is cleared when a stride disruption happens (ex new memcopy execution)</p></li>
<li><p>It is set on cache miss (set win over clear)</p></li>
<li><p>An instruction will only trigger a prefetch if it miss or
if its “missed” field is already set.</p></li>
</ul>
<p>For example, in a hardware simulation test
(RV64, 20 cycles memory latency, 16xload loop), this addition increased
the memory read memory bandwidth from 3.6 bytes/cycle to 6.8 bytes per cycle.</p>
<p>Note that if you want to take full advantage of this prefetcher, you need to
have enough hardware refill/writeback slots in the LsuL1Plugin.</p>
<p>Also, prefetch which fail (ex : because of hazards in L1) aren’t replayed.</p>
<p>The prefetcher can be turned off by setting the CSR 0x7FF bit 1.</p>
</section>
<section id="performance-measurements">
<h3>performance measurements<a class="headerlink" href="#performance-measurements" title="Permalink to this heading"></a></h3>
<p>Here are a few performance gain measurements done on litex with a :</p>
<ul class="simple">
<li><p>quad-core RV64GC running at 200 Mhz</p></li>
<li><p>16 KB L1 cache for each core</p></li>
<li><p>512 KB of l2 cache shared (128 bits data bus)</p></li>
<li><p>4 refill slots + 4 writeback slots + 32 entry store queue + 4 slots store queue</p></li>
</ul>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">Prefetch performance</span><a class="headerlink" href="#id1" title="Permalink to this table"></a></caption>
<colgroup>
<col style="width: 40%" />
<col style="width: 30%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Test</p></th>
<th class="head"><p>No prefetch</p></th>
<th class="head"><p>RPT prefetch</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Litex bios read speed</p></td>
<td><p>204.2MiB/s</p></td>
<td><p>790.9MiB/s</p></td>
</tr>
<tr class="row-odd"><td><p>Litex bios write speed</p></td>
<td><p>559.2MiB/s</p></td>
<td><p>576.8MiB/s</p></td>
</tr>
<tr class="row-even"><td><p>iperf3 RX</p></td>
<td><p>617 Mbits/sec</p></td>
<td><p>766 Mbits/sec</p></td>
</tr>
<tr class="row-odd"><td><p>iperf3 TX</p></td>
<td><p>623 Mbits/sec</p></td>
<td><p>623 Mbits/sec</p></td>
</tr>
<tr class="row-even"><td><p>chocolate-doom -1 demo1.lmp</p></td>
<td><p>43.1 fps</p></td>
<td><p>50.2 fps</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="custom.html" class="btn btn-neutral float-left" title="Custom instruction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fpu.html" class="btn btn-neutral float-right" title="FPU" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 - 2024, VexiiRiscv.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
    <!-- source/_templates/footer.html -->
    
    <div class="doc-footer-current-version"><p>
    Version: master git~3a49e91 2024-11-11
    </p></div>
    


</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: master
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
       <dt>Languages</dt>
       <dd class="rtd-current-item">
         <a href="#">en</a>
       </dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="lsu.html">master</a></dd>
    </dl>
    <dl>
      <dt>Downloads</dt>
      <dd><a href="../../artefacts/VexiiRiscv_docs-master.">HTML</a></dd>
      <dd><a href="../../artefacts/VexiiRiscv_docs-master-SingleHTML.zip">SingleHTML</a></dd>
      <dd><a href="../../artefacts/VexiiRiscv_docs-master.pdf">PDF</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>